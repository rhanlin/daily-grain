# Feature Specification: Backlog Multi-Select

**Feature Branch**: `012-backlog-multi-select`  
**Created**: 2026-02-04  
**Status**: Draft  
**Input**: User description: "在計劃頁面裡，當打開 Backlog Drawer 時，需要新增\"多選功能\"，同一個 Task 裡的子任務，當長按子任務時開啟\"多選模式\"，此時可以進行多選 items 並且下方出現加入按鈕，點擊加入後能一次將選取的多個子任務加到每日計劃中"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 跨任務批次新增子任務 (Batch Adding Subtasks within Category) (Priority: P1)

使用者在每日計畫頁面打開「備忘清單」(Backlog Drawer) 時，希望能一次選取**同一個分類下跨不同任務**的多個子任務並加入今日計畫。透過長按觸發多選模式後，使用者可以自由勾選當前分類分頁內的所有子項。若使用者滑動 Carousel 切換至其他分類，原本的選取會被保留，但其他分類分頁將進入鎖定狀態，直到使用者完成新增或取消為止。

**Why this priority**: 提升手機端操作效率，支援更靈活的批次排程，並防止資料在不同分類間產生選取衝突。

**Independent Test**: 打開 Backlog Drawer，在分類 A 中長按一個子任務進入多選模式，勾選來自 Task 1 與 Task 2 的多個子項。滑動至分類 B，驗證分類 B 的項目是否不可選取，最後點擊底部的「加入計畫」，確認選取項正確加入。

**Acceptance Scenarios**:

1. **Given** 使用者位於 Backlog Drawer, **When** 長按任一子任務, **Then** Drawer 進入「多選模式」，顯示選取框。
2. **Given** 處於多選模式且已選取項目, **When** 點擊**同一個分類**下的任何子任務 (無論是否同一個父任務), **Then** 該項目切換選取狀態。
3. **Given** 處於多選模式, **When** 滑動切換至**不同分類**的分頁, **Then** 原選取狀態保留，但當前分頁的項目應呈現「鎖定/不可選取」狀態。
4. **Given** 處於多選模式, **When** 在任何分頁點擊底部的「加入 (N)」按鈕, **Then** 所有選取項目被加入每日計畫，多選模式關閉並重置。

---

## Requirements *(mandatory)*

### Clarifications
#### Session 2026-02-04
- Q: MoreHorizontal 圖示放置位置？ → A: 卡片最右側
- Q: 是否徹底移除所有長按行為？ → A: 是，全站統一移除長按並以選單圖示取代（註：此功能為例外引入）
- Q: 依矩陣排序時的拖曳行為？ → A: 禁用拖曳
- Q: 子任務的拖曳權限？ → A: 是，兩者皆可
- Q: 切換分類分頁時的處理？ → A: 保持但鎖定：保留原分類選取，其他分頁變為不可選取
- Q: 跨分頁時「加入」按鈕顯示？ → A: 維持可見：可在任何分頁執行選取項的新增

### Functional Requirements

- **FR-001**: **長按觸發機制**: 在 Backlog Drawer 內偵測子任務的長按事件（例外處理），觸發後切換至多選狀態。
- **FR-002**: **同分類選取範圍**: 多選模式必須限制在**同一個分類**範圍內；允許選取該分類下不同父任務的子項，但禁止同時選取來自兩個不同分類的項目。
- **FR-003**: **跨分頁鎖定邏輯**: 當存在有效選取項時，若使用者切換至其他分類分頁，系統必須禁用該分頁的選取功能，並提供視覺提示（如：灰階）。
- **FR-004**: **全域浮動操作列**: 多選模式下，Drawer 底部顯示常駐的操作列，包含「加入今日計畫 (N)」與「取消」，不隨分頁切換而消失。
- **FR-005**: **批次寫入與重置**: 執行加入後，一次性更新 `dailyPlanItems` 並立即清除所有選取狀態，恢復一般操作模式。

### Key Entities

- **DailyPlanItem**: 每日計畫中的排程項，包含日期、關聯 ID 與類型。
- **SubTask**: 隸屬於任務的子項。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者完成一次 5 個項目的批次新增操作所需時間，應比手動點擊 5 次減少至少 40%。
- **SC-002**: 在多選模式下的項目選取響應時間 (視覺反饋) 小於 100ms。
- **SC-003**: 批次新增操作的成功率為 100%，無遺漏或重複建立現象。